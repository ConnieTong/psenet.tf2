#!/usr/bin/python3
# __*__ coding: utf-8 __*__

'''
@Author: SimonWang00
@Os：Windows 10 x64
@Contact: simon_wang00@163.com
@Software: PY PyCharm
@File: settings.py
@Time: 2020/12/15 15:15
'''

# Copyright 2020 The SimonWang00. All Rights Reserved.
#
# @Desc:
# 1).build fpn + resnet model;
# 2).define dice loss;
# 3).define model train loss;
# 4).define total loss;
# 5).define average_gradients to update our weight;
# ==============================================================================
# LINT.IfChange

"""build FPN + ResNet model"""


'''
This model build by resnet50, using resnet FLOPS is: 48 Million

Model: "PseNet"
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_images (InputLayer)       [(None, None, None,  0                                            
__________________________________________________________________________________________________
zero_padding2d (ZeroPadding2D)  (None, None, None, 3 0           input_images[0][0]               
__________________________________________________________________________________________________
conv1 (Conv2D)                  (None, None, None, 6 9472        zero_padding2d[0][0]             
__________________________________________________________________________________________________
bn_conv1 (BatchNormalization)   (None, None, None, 6 256         conv1[0][0]                      
__________________________________________________________________________________________________
activation (Activation)         (None, None, None, 6 0           bn_conv1[0][0]                   
__________________________________________________________________________________________________
max_pooling2d (MaxPooling2D)    (None, None, None, 6 0           activation[0][0]                 
__________________________________________________________________________________________________
res2a_branch2a (Conv2D)         (None, None, None, 6 4096        max_pooling2d[0][0]              
__________________________________________________________________________________________________
bn2a_branch2a (BatchNormalizati (None, None, None, 6 256         res2a_branch2a[0][0]             
__________________________________________________________________________________________________
activation_1 (Activation)       (None, None, None, 6 0           bn2a_branch2a[0][0]              
__________________________________________________________________________________________________
res2a_branch2b (Conv2D)         (None, None, None, 6 36864       activation_1[0][0]               
__________________________________________________________________________________________________
bn2a_branch2b (BatchNormalizati (None, None, None, 6 256         res2a_branch2b[0][0]             
__________________________________________________________________________________________________
activation_2 (Activation)       (None, None, None, 6 0           bn2a_branch2b[0][0]              
__________________________________________________________________________________________________
res2a_branch2c (Conv2D)         (None, None, None, 2 16384       activation_2[0][0]               
__________________________________________________________________________________________________
res2a_branch1 (Conv2D)          (None, None, None, 2 16384       max_pooling2d[0][0]              
__________________________________________________________________________________________________
bn2a_branch2c (BatchNormalizati (None, None, None, 2 1024        res2a_branch2c[0][0]             
__________________________________________________________________________________________________
bn2a_branch1 (BatchNormalizatio (None, None, None, 2 1024        res2a_branch1[0][0]              
__________________________________________________________________________________________________
add (Add)                       (None, None, None, 2 0           bn2a_branch2c[0][0]              
                                                                 bn2a_branch1[0][0]               
__________________________________________________________________________________________________
res2a_out (Activation)          (None, None, None, 2 0           add[0][0]                        
__________________________________________________________________________________________________
res2b_branch2a (Conv2D)         (None, None, None, 6 16384       res2a_out[0][0]                  
__________________________________________________________________________________________________
bn2b_branch2a (BatchNormalizati (None, None, None, 6 256         res2b_branch2a[0][0]             
__________________________________________________________________________________________________
activation_3 (Activation)       (None, None, None, 6 0           bn2b_branch2a[0][0]              
__________________________________________________________________________________________________
res2b_branch2b (Conv2D)         (None, None, None, 6 36864       activation_3[0][0]               
__________________________________________________________________________________________________
bn2b_branch2b (BatchNormalizati (None, None, None, 6 256         res2b_branch2b[0][0]             
__________________________________________________________________________________________________
activation_4 (Activation)       (None, None, None, 6 0           bn2b_branch2b[0][0]              
__________________________________________________________________________________________________
res2b_branch2c (Conv2D)         (None, None, None, 2 16384       activation_4[0][0]               
__________________________________________________________________________________________________
bn2b_branch2c (BatchNormalizati (None, None, None, 2 1024        res2b_branch2c[0][0]             
__________________________________________________________________________________________________
add_1 (Add)                     (None, None, None, 2 0           bn2b_branch2c[0][0]              
                                                                 res2a_out[0][0]                  
__________________________________________________________________________________________________
res2b_out (Activation)          (None, None, None, 2 0           add_1[0][0]                      
__________________________________________________________________________________________________
res2c_branch2a (Conv2D)         (None, None, None, 6 16384       res2b_out[0][0]                  
__________________________________________________________________________________________________
bn2c_branch2a (BatchNormalizati (None, None, None, 6 256         res2c_branch2a[0][0]             
__________________________________________________________________________________________________
activation_5 (Activation)       (None, None, None, 6 0           bn2c_branch2a[0][0]              
__________________________________________________________________________________________________
res2c_branch2b (Conv2D)         (None, None, None, 6 36864       activation_5[0][0]               
__________________________________________________________________________________________________
bn2c_branch2b (BatchNormalizati (None, None, None, 6 256         res2c_branch2b[0][0]             
__________________________________________________________________________________________________
activation_6 (Activation)       (None, None, None, 6 0           bn2c_branch2b[0][0]              
__________________________________________________________________________________________________
res2c_branch2c (Conv2D)         (None, None, None, 2 16384       activation_6[0][0]               
__________________________________________________________________________________________________
bn2c_branch2c (BatchNormalizati (None, None, None, 2 1024        res2c_branch2c[0][0]             
__________________________________________________________________________________________________
add_2 (Add)                     (None, None, None, 2 0           bn2c_branch2c[0][0]              
                                                                 res2b_out[0][0]                  
__________________________________________________________________________________________________
res2c_out (Activation)          (None, None, None, 2 0           add_2[0][0]                      
__________________________________________________________________________________________________
res3a_branch2a (Conv2D)         (None, None, None, 1 32768       res2c_out[0][0]                  
__________________________________________________________________________________________________
bn3a_branch2a (BatchNormalizati (None, None, None, 1 512         res3a_branch2a[0][0]             
__________________________________________________________________________________________________
activation_7 (Activation)       (None, None, None, 1 0           bn3a_branch2a[0][0]              
__________________________________________________________________________________________________
res3a_branch2b (Conv2D)         (None, None, None, 1 147456      activation_7[0][0]               
__________________________________________________________________________________________________
bn3a_branch2b (BatchNormalizati (None, None, None, 1 512         res3a_branch2b[0][0]             
__________________________________________________________________________________________________
activation_8 (Activation)       (None, None, None, 1 0           bn3a_branch2b[0][0]              
__________________________________________________________________________________________________
res3a_branch2c (Conv2D)         (None, None, None, 5 65536       activation_8[0][0]               
__________________________________________________________________________________________________
res3a_branch1 (Conv2D)          (None, None, None, 5 131072      res2c_out[0][0]                  
__________________________________________________________________________________________________
bn3a_branch2c (BatchNormalizati (None, None, None, 5 2048        res3a_branch2c[0][0]             
__________________________________________________________________________________________________
bn3a_branch1 (BatchNormalizatio (None, None, None, 5 2048        res3a_branch1[0][0]              
__________________________________________________________________________________________________
add_3 (Add)                     (None, None, None, 5 0           bn3a_branch2c[0][0]              
                                                                 bn3a_branch1[0][0]               
__________________________________________________________________________________________________
res3a_out (Activation)          (None, None, None, 5 0           add_3[0][0]                      
__________________________________________________________________________________________________
res3b_branch2a (Conv2D)         (None, None, None, 1 65536       res3a_out[0][0]                  
__________________________________________________________________________________________________
bn3b_branch2a (BatchNormalizati (None, None, None, 1 512         res3b_branch2a[0][0]             
__________________________________________________________________________________________________
activation_9 (Activation)       (None, None, None, 1 0           bn3b_branch2a[0][0]              
__________________________________________________________________________________________________
res3b_branch2b (Conv2D)         (None, None, None, 1 147456      activation_9[0][0]               
__________________________________________________________________________________________________
bn3b_branch2b (BatchNormalizati (None, None, None, 1 512         res3b_branch2b[0][0]             
__________________________________________________________________________________________________
activation_10 (Activation)      (None, None, None, 1 0           bn3b_branch2b[0][0]              
__________________________________________________________________________________________________
res3b_branch2c (Conv2D)         (None, None, None, 5 65536       activation_10[0][0]              
__________________________________________________________________________________________________
bn3b_branch2c (BatchNormalizati (None, None, None, 5 2048        res3b_branch2c[0][0]             
__________________________________________________________________________________________________
add_4 (Add)                     (None, None, None, 5 0           bn3b_branch2c[0][0]              
                                                                 res3a_out[0][0]                  
__________________________________________________________________________________________________
res3b_out (Activation)          (None, None, None, 5 0           add_4[0][0]                      
__________________________________________________________________________________________________
res3c_branch2a (Conv2D)         (None, None, None, 1 65536       res3b_out[0][0]                  
__________________________________________________________________________________________________
bn3c_branch2a (BatchNormalizati (None, None, None, 1 512         res3c_branch2a[0][0]             
__________________________________________________________________________________________________
activation_11 (Activation)      (None, None, None, 1 0           bn3c_branch2a[0][0]              
__________________________________________________________________________________________________
res3c_branch2b (Conv2D)         (None, None, None, 1 147456      activation_11[0][0]              
__________________________________________________________________________________________________
bn3c_branch2b (BatchNormalizati (None, None, None, 1 512         res3c_branch2b[0][0]             
__________________________________________________________________________________________________
activation_12 (Activation)      (None, None, None, 1 0           bn3c_branch2b[0][0]              
__________________________________________________________________________________________________
res3c_branch2c (Conv2D)         (None, None, None, 5 65536       activation_12[0][0]              
__________________________________________________________________________________________________
bn3c_branch2c (BatchNormalizati (None, None, None, 5 2048        res3c_branch2c[0][0]             
__________________________________________________________________________________________________
add_5 (Add)                     (None, None, None, 5 0           bn3c_branch2c[0][0]              
                                                                 res3b_out[0][0]                  
__________________________________________________________________________________________________
res3c_out (Activation)          (None, None, None, 5 0           add_5[0][0]                      
__________________________________________________________________________________________________
res3d_branch2a (Conv2D)         (None, None, None, 1 65536       res3c_out[0][0]                  
__________________________________________________________________________________________________
bn3d_branch2a (BatchNormalizati (None, None, None, 1 512         res3d_branch2a[0][0]             
__________________________________________________________________________________________________
activation_13 (Activation)      (None, None, None, 1 0           bn3d_branch2a[0][0]              
__________________________________________________________________________________________________
res3d_branch2b (Conv2D)         (None, None, None, 1 147456      activation_13[0][0]              
__________________________________________________________________________________________________
bn3d_branch2b (BatchNormalizati (None, None, None, 1 512         res3d_branch2b[0][0]             
__________________________________________________________________________________________________
activation_14 (Activation)      (None, None, None, 1 0           bn3d_branch2b[0][0]              
__________________________________________________________________________________________________
res3d_branch2c (Conv2D)         (None, None, None, 5 65536       activation_14[0][0]              
__________________________________________________________________________________________________
bn3d_branch2c (BatchNormalizati (None, None, None, 5 2048        res3d_branch2c[0][0]             
__________________________________________________________________________________________________
add_6 (Add)                     (None, None, None, 5 0           bn3d_branch2c[0][0]              
                                                                 res3c_out[0][0]                  
__________________________________________________________________________________________________
res3d_out (Activation)          (None, None, None, 5 0           add_6[0][0]                      
__________________________________________________________________________________________________
res4a_branch2a (Conv2D)         (None, None, None, 2 131072      res3d_out[0][0]                  
__________________________________________________________________________________________________
bn4a_branch2a (BatchNormalizati (None, None, None, 2 1024        res4a_branch2a[0][0]             
__________________________________________________________________________________________________
activation_15 (Activation)      (None, None, None, 2 0           bn4a_branch2a[0][0]              
__________________________________________________________________________________________________
res4a_branch2b (Conv2D)         (None, None, None, 2 589824      activation_15[0][0]              
__________________________________________________________________________________________________
bn4a_branch2b (BatchNormalizati (None, None, None, 2 1024        res4a_branch2b[0][0]             
__________________________________________________________________________________________________
activation_16 (Activation)      (None, None, None, 2 0           bn4a_branch2b[0][0]              
__________________________________________________________________________________________________
res4a_branch2c (Conv2D)         (None, None, None, 1 262144      activation_16[0][0]              
__________________________________________________________________________________________________
res4a_branch1 (Conv2D)          (None, None, None, 1 524288      res3d_out[0][0]                  
__________________________________________________________________________________________________
bn4a_branch2c (BatchNormalizati (None, None, None, 1 4096        res4a_branch2c[0][0]             
__________________________________________________________________________________________________
bn4a_branch1 (BatchNormalizatio (None, None, None, 1 4096        res4a_branch1[0][0]              
__________________________________________________________________________________________________
add_7 (Add)                     (None, None, None, 1 0           bn4a_branch2c[0][0]              
                                                                 bn4a_branch1[0][0]               
__________________________________________________________________________________________________
res4a_out (Activation)          (None, None, None, 1 0           add_7[0][0]                      
__________________________________________________________________________________________________
res4b_branch2a (Conv2D)         (None, None, None, 2 262144      res4a_out[0][0]                  
__________________________________________________________________________________________________
bn4b_branch2a (BatchNormalizati (None, None, None, 2 1024        res4b_branch2a[0][0]             
__________________________________________________________________________________________________
activation_17 (Activation)      (None, None, None, 2 0           bn4b_branch2a[0][0]              
__________________________________________________________________________________________________
res4b_branch2b (Conv2D)         (None, None, None, 2 589824      activation_17[0][0]              
__________________________________________________________________________________________________
bn4b_branch2b (BatchNormalizati (None, None, None, 2 1024        res4b_branch2b[0][0]             
__________________________________________________________________________________________________
activation_18 (Activation)      (None, None, None, 2 0           bn4b_branch2b[0][0]              
__________________________________________________________________________________________________
res4b_branch2c (Conv2D)         (None, None, None, 1 262144      activation_18[0][0]              
__________________________________________________________________________________________________
bn4b_branch2c (BatchNormalizati (None, None, None, 1 4096        res4b_branch2c[0][0]             
__________________________________________________________________________________________________
add_8 (Add)                     (None, None, None, 1 0           bn4b_branch2c[0][0]              
                                                                 res4a_out[0][0]                  
__________________________________________________________________________________________________
res4b_out (Activation)          (None, None, None, 1 0           add_8[0][0]                      
__________________________________________________________________________________________________
res4c_branch2a (Conv2D)         (None, None, None, 2 262144      res4b_out[0][0]                  
__________________________________________________________________________________________________
bn4c_branch2a (BatchNormalizati (None, None, None, 2 1024        res4c_branch2a[0][0]             
__________________________________________________________________________________________________
activation_19 (Activation)      (None, None, None, 2 0           bn4c_branch2a[0][0]              
__________________________________________________________________________________________________
res4c_branch2b (Conv2D)         (None, None, None, 2 589824      activation_19[0][0]              
__________________________________________________________________________________________________
bn4c_branch2b (BatchNormalizati (None, None, None, 2 1024        res4c_branch2b[0][0]             
__________________________________________________________________________________________________
activation_20 (Activation)      (None, None, None, 2 0           bn4c_branch2b[0][0]              
__________________________________________________________________________________________________
res4c_branch2c (Conv2D)         (None, None, None, 1 262144      activation_20[0][0]              
__________________________________________________________________________________________________
bn4c_branch2c (BatchNormalizati (None, None, None, 1 4096        res4c_branch2c[0][0]             
__________________________________________________________________________________________________
add_9 (Add)                     (None, None, None, 1 0           bn4c_branch2c[0][0]              
                                                                 res4b_out[0][0]                  
__________________________________________________________________________________________________
res4c_out (Activation)          (None, None, None, 1 0           add_9[0][0]                      
__________________________________________________________________________________________________
res4d_branch2a (Conv2D)         (None, None, None, 2 262144      res4c_out[0][0]                  
__________________________________________________________________________________________________
bn4d_branch2a (BatchNormalizati (None, None, None, 2 1024        res4d_branch2a[0][0]             
__________________________________________________________________________________________________
activation_21 (Activation)      (None, None, None, 2 0           bn4d_branch2a[0][0]              
__________________________________________________________________________________________________
res4d_branch2b (Conv2D)         (None, None, None, 2 589824      activation_21[0][0]              
__________________________________________________________________________________________________
bn4d_branch2b (BatchNormalizati (None, None, None, 2 1024        res4d_branch2b[0][0]             
__________________________________________________________________________________________________
activation_22 (Activation)      (None, None, None, 2 0           bn4d_branch2b[0][0]              
__________________________________________________________________________________________________
res4d_branch2c (Conv2D)         (None, None, None, 1 262144      activation_22[0][0]              
__________________________________________________________________________________________________
bn4d_branch2c (BatchNormalizati (None, None, None, 1 4096        res4d_branch2c[0][0]             
__________________________________________________________________________________________________
add_10 (Add)                    (None, None, None, 1 0           bn4d_branch2c[0][0]              
                                                                 res4c_out[0][0]                  
__________________________________________________________________________________________________
res4d_out (Activation)          (None, None, None, 1 0           add_10[0][0]                     
__________________________________________________________________________________________________
res4e_branch2a (Conv2D)         (None, None, None, 2 262144      res4d_out[0][0]                  
__________________________________________________________________________________________________
bn4e_branch2a (BatchNormalizati (None, None, None, 2 1024        res4e_branch2a[0][0]             
__________________________________________________________________________________________________
activation_23 (Activation)      (None, None, None, 2 0           bn4e_branch2a[0][0]              
__________________________________________________________________________________________________
res4e_branch2b (Conv2D)         (None, None, None, 2 589824      activation_23[0][0]              
__________________________________________________________________________________________________
bn4e_branch2b (BatchNormalizati (None, None, None, 2 1024        res4e_branch2b[0][0]             
__________________________________________________________________________________________________
activation_24 (Activation)      (None, None, None, 2 0           bn4e_branch2b[0][0]              
__________________________________________________________________________________________________
res4e_branch2c (Conv2D)         (None, None, None, 1 262144      activation_24[0][0]              
__________________________________________________________________________________________________
bn4e_branch2c (BatchNormalizati (None, None, None, 1 4096        res4e_branch2c[0][0]             
__________________________________________________________________________________________________
add_11 (Add)                    (None, None, None, 1 0           bn4e_branch2c[0][0]              
                                                                 res4d_out[0][0]                  
__________________________________________________________________________________________________
res4e_out (Activation)          (None, None, None, 1 0           add_11[0][0]                     
__________________________________________________________________________________________________
res4f_branch2a (Conv2D)         (None, None, None, 2 262144      res4e_out[0][0]                  
__________________________________________________________________________________________________
bn4f_branch2a (BatchNormalizati (None, None, None, 2 1024        res4f_branch2a[0][0]             
__________________________________________________________________________________________________
activation_25 (Activation)      (None, None, None, 2 0           bn4f_branch2a[0][0]              
__________________________________________________________________________________________________
res4f_branch2b (Conv2D)         (None, None, None, 2 589824      activation_25[0][0]              
__________________________________________________________________________________________________
bn4f_branch2b (BatchNormalizati (None, None, None, 2 1024        res4f_branch2b[0][0]             
__________________________________________________________________________________________________
activation_26 (Activation)      (None, None, None, 2 0           bn4f_branch2b[0][0]              
__________________________________________________________________________________________________
res4f_branch2c (Conv2D)         (None, None, None, 1 262144      activation_26[0][0]              
__________________________________________________________________________________________________
bn4f_branch2c (BatchNormalizati (None, None, None, 1 4096        res4f_branch2c[0][0]             
__________________________________________________________________________________________________
add_12 (Add)                    (None, None, None, 1 0           bn4f_branch2c[0][0]              
                                                                 res4e_out[0][0]                  
__________________________________________________________________________________________________
res4f_out (Activation)          (None, None, None, 1 0           add_12[0][0]                     
__________________________________________________________________________________________________
res5a_branch2a (Conv2D)         (None, None, None, 5 524288      res4f_out[0][0]                  
__________________________________________________________________________________________________
bn5a_branch2a (BatchNormalizati (None, None, None, 5 2048        res5a_branch2a[0][0]             
__________________________________________________________________________________________________
activation_27 (Activation)      (None, None, None, 5 0           bn5a_branch2a[0][0]              
__________________________________________________________________________________________________
res5a_branch2b (Conv2D)         (None, None, None, 5 2359296     activation_27[0][0]              
__________________________________________________________________________________________________
bn5a_branch2b (BatchNormalizati (None, None, None, 5 2048        res5a_branch2b[0][0]             
__________________________________________________________________________________________________
activation_28 (Activation)      (None, None, None, 5 0           bn5a_branch2b[0][0]              
__________________________________________________________________________________________________
res5a_branch2c (Conv2D)         (None, None, None, 2 1048576     activation_28[0][0]              
__________________________________________________________________________________________________
res5a_branch1 (Conv2D)          (None, None, None, 2 2097152     res4f_out[0][0]                  
__________________________________________________________________________________________________
bn5a_branch2c (BatchNormalizati (None, None, None, 2 8192        res5a_branch2c[0][0]             
__________________________________________________________________________________________________
bn5a_branch1 (BatchNormalizatio (None, None, None, 2 8192        res5a_branch1[0][0]              
__________________________________________________________________________________________________
add_13 (Add)                    (None, None, None, 2 0           bn5a_branch2c[0][0]              
                                                                 bn5a_branch1[0][0]               
__________________________________________________________________________________________________
res5a_out (Activation)          (None, None, None, 2 0           add_13[0][0]                     
__________________________________________________________________________________________________
res5b_branch2a (Conv2D)         (None, None, None, 5 1048576     res5a_out[0][0]                  
__________________________________________________________________________________________________
bn5b_branch2a (BatchNormalizati (None, None, None, 5 2048        res5b_branch2a[0][0]             
__________________________________________________________________________________________________
activation_29 (Activation)      (None, None, None, 5 0           bn5b_branch2a[0][0]              
__________________________________________________________________________________________________
res5b_branch2b (Conv2D)         (None, None, None, 5 2359296     activation_29[0][0]              
__________________________________________________________________________________________________
bn5b_branch2b (BatchNormalizati (None, None, None, 5 2048        res5b_branch2b[0][0]             
__________________________________________________________________________________________________
activation_30 (Activation)      (None, None, None, 5 0           bn5b_branch2b[0][0]              
__________________________________________________________________________________________________
res5b_branch2c (Conv2D)         (None, None, None, 2 1048576     activation_30[0][0]              
__________________________________________________________________________________________________
bn5b_branch2c (BatchNormalizati (None, None, None, 2 8192        res5b_branch2c[0][0]             
__________________________________________________________________________________________________
add_14 (Add)                    (None, None, None, 2 0           bn5b_branch2c[0][0]              
                                                                 res5a_out[0][0]                  
__________________________________________________________________________________________________
res5b_out (Activation)          (None, None, None, 2 0           add_14[0][0]                     
__________________________________________________________________________________________________
res5c_branch2a (Conv2D)         (None, None, None, 5 1048576     res5b_out[0][0]                  
__________________________________________________________________________________________________
bn5c_branch2a (BatchNormalizati (None, None, None, 5 2048        res5c_branch2a[0][0]             
__________________________________________________________________________________________________
activation_31 (Activation)      (None, None, None, 5 0           bn5c_branch2a[0][0]              
__________________________________________________________________________________________________
res5c_branch2b (Conv2D)         (None, None, None, 5 2359296     activation_31[0][0]              
__________________________________________________________________________________________________
bn5c_branch2b (BatchNormalizati (None, None, None, 5 2048        res5c_branch2b[0][0]             
__________________________________________________________________________________________________
activation_32 (Activation)      (None, None, None, 5 0           bn5c_branch2b[0][0]              
__________________________________________________________________________________________________
res5c_branch2c (Conv2D)         (None, None, None, 2 1048576     activation_32[0][0]              
__________________________________________________________________________________________________
bn5c_branch2c (BatchNormalizati (None, None, None, 2 8192        res5c_branch2c[0][0]             
__________________________________________________________________________________________________
add_15 (Add)                    (None, None, None, 2 0           bn5c_branch2c[0][0]              
                                                                 res5b_out[0][0]                  
__________________________________________________________________________________________________
res5c_out (Activation)          (None, None, None, 2 0           add_15[0][0]                     
__________________________________________________________________________________________________
fpn_c5p5 (Conv2D)               (None, None, None, 2 524544      res5c_out[0][0]                  
__________________________________________________________________________________________________
fpn_p5upsampled (UpSampling2D)  (None, None, None, 2 0           fpn_c5p5[0][0]                   
__________________________________________________________________________________________________
fpn_c4p4 (Conv2D)               (None, None, None, 2 262400      res4f_out[0][0]                  
__________________________________________________________________________________________________
fpn_p4add (Add)                 (None, None, None, 2 0           fpn_p5upsampled[0][0]            
                                                                 fpn_c4p4[0][0]                   
__________________________________________________________________________________________________
fpn_p4upsampled (UpSampling2D)  (None, None, None, 2 0           fpn_p4add[0][0]                  
__________________________________________________________________________________________________
fpn_c3p3 (Conv2D)               (None, None, None, 2 131328      res3d_out[0][0]                  
__________________________________________________________________________________________________
fpn_p3add (Add)                 (None, None, None, 2 0           fpn_p4upsampled[0][0]            
                                                                 fpn_c3p3[0][0]                   
__________________________________________________________________________________________________
fpn_p3upsampled (UpSampling2D)  (None, None, None, 2 0           fpn_p3add[0][0]                  
__________________________________________________________________________________________________
fpn_c2p2 (Conv2D)               (None, None, None, 2 65792       res2c_out[0][0]                  
__________________________________________________________________________________________________
fpn_p2add (Add)                 (None, None, None, 2 0           fpn_p3upsampled[0][0]            
                                                                 fpn_c2p2[0][0]                   
__________________________________________________________________________________________________
fpn_p3 (Conv2D)                 (None, None, None, 2 590080      fpn_p3add[0][0]                  
__________________________________________________________________________________________________
fpn_p4 (Conv2D)                 (None, None, None, 2 590080      fpn_p4add[0][0]                  
__________________________________________________________________________________________________
fpn_p5 (Conv2D)                 (None, None, None, 2 590080      fpn_c5p5[0][0]                   
__________________________________________________________________________________________________
fpn_p2 (Conv2D)                 (None, None, None, 2 590080      fpn_p2add[0][0]                  
__________________________________________________________________________________________________
up_sampling2d (UpSampling2D)    (None, None, None, 2 0           fpn_p3[0][0]                     
__________________________________________________________________________________________________
up_sampling2d_1 (UpSampling2D)  (None, None, None, 2 0           fpn_p4[0][0]                     
__________________________________________________________________________________________________
up_sampling2d_2 (UpSampling2D)  (None, None, None, 2 0           fpn_p5[0][0]                     
__________________________________________________________________________________________________
concatenate (Concatenate)       (None, None, None, 1 0           fpn_p2[0][0]                     
                                                                 up_sampling2d[0][0]              
                                                                 up_sampling2d_1[0][0]            
                                                                 up_sampling2d_2[0][0]            
__________________________________________________________________________________________________
build_feature_pyramid (Conv2D)  (None, None, None, 2 2359552     concatenate[0][0]                
__________________________________________________________________________________________________
batch_normalization (BatchNorma (None, None, None, 2 1024        build_feature_pyramid[0][0]      
__________________________________________________________________________________________________
activation_33 (Activation)      (None, None, None, 2 0           batch_normalization[0][0]        
__________________________________________________________________________________________________
conv2d (Conv2D)                 (None, None, None, 6 1542        activation_33[0][0]              
__________________________________________________________________________________________________
activation_34 (Activation)      (None, None, None, 6 0           conv2d[0][0]                     
==================================================================================================
Total params: 29,267,718
Trainable params: 29,214,086
Non-trainable params: 53,632
__________________________________________________________________________________________________

'''

import tensorflow as tf
from typing import Tuple
from tensorflow.keras.layers import Conv2D, Input, Activation
from tensorflow.keras import Model, Sequential

from feature_pyramid import build_feature_pyramid
from settings import OUTPUTS, BATCH_LOSS, RATE_OHEM, SN, RATE_LC_LS, METRIC_IOU_BATCH

def __model() -> Model:
    '''
    define the model, we use tf2's implemention of resnet

    Parameters
    ----------
    outputs : default 6, if none, outputs=6

    Returns
    -------

    '''
    input_images = Input([None, None, 3], name='input_images')
    F = build_feature_pyramid(input_images)         #(None, 160, 160, 256)
    S = Conv2D(OUTPUTS, (1,1))(F)       #(None, 160, 160, 6)
    seg_s_pred = Activation("sigmoid")(S)       #(None, 160, 160, 6)
    # model initilizer
    model = Model(inputs=input_images, outputs=seg_s_pred, name="PseNet")
    # model.summary()
    return model


def build_loss(y_true,y_pred) -> float:
    '''
    build psenet loss

    References from : https://zhuanlan.zhihu.com/p/91019893?from_voters_page=true

    Parameters
    ----------
    y_true :
    y_pred :

    Returns
    -------

    '''
    y_true = tf.cast(y_true, tf.float32)
    y_pred = tf.cast(y_pred, tf.float32)

    total_loss = 0.0
    Lc_loss = 0.0
    Ls_loss = 0.0

    y_true_Lc = y_true[:, :, :, -1:]
    y_pred_Lc = y_pred[:, :, :, -1:]

    # 缩放
    y_true_Ls = y_true[:, :, :, :-1]
    y_pred_Ls = y_pred[:, :, :, :-1]

    # adopt ohem to Lc
    M = ohem_batch(y_true_Lc, y_pred_Lc)

    Lc_loss = 1 - dice_loss(y_true_Lc * M, y_pred_Lc * M)

    # ignore the pixels of non-text region
    # in the segmentation result Sn to avoid a certain redundancy.
    W = y_pred_Lc > 0.5
    pos_mask = tf.cast(y_true_Lc, tf.bool)
    W = tf.logical_or(pos_mask, W)
    W = tf.cast(W, tf.float32)

    for i in range(SN - 1):
        Ls_loss += dice_loss(y_true_Ls[:, :, :, i:i + 1] * W, y_pred_Ls[:, :, :, i:i + 1] * W)
    Ls_loss = 1.0 - Ls_loss / (SN - 1)

    # Ls_loss = tf.print(Ls_loss,['lc_loss.->',Lc_loss,'ls_loss->',Ls_loss])

    # λ balances the importance between Lc and Ls.
    total_loss = RATE_LC_LS * Lc_loss + (1 - RATE_LC_LS) * Ls_loss
    return total_loss


def ohem_batch(y_true_Lc, y_pred_Lc ):
    '''
    It is a high-order function that repeatedly applies the callable function fn to the sequence of elems elements.
    批量
    Parameters
    ----------
    y_true_Lc :
    y_pred_Lc :

    Returns
    -------

    '''
    M = tf.map_fn(ohem_single, (y_true_Lc, y_pred_Lc), dtype=tf.float32)
    return tf.stack(M)


def ohem_single(s_Lc:Tuple):
    '''
    在线难例挖掘，调整网络学习难样本
    Parameters
    ----------
    s_Lc : tuple , (s_y_ture_Lc, s_y_pred_Lc)

    Returns
    -------

    '''
    s_y_ture_Lc, s_y_pred_Lc = s_Lc
    n_pos = tf.reduce_sum(s_y_ture_Lc)

    # n_pos = tf.print(n_pos,['n_pos->',n_pos])

    def has_pos():
        n_max_neg = tf.reduce_sum(tf.cast(s_y_ture_Lc > -1.0, tf.int32))

        # n_max_neg = tf.print(n_max_neg,['n_max_neg',n_max_neg])
        n_neg = n_pos * RATE_OHEM
        n_neg = tf.cast(n_neg, tf.int32)
        n_neg = tf.minimum(n_neg, n_max_neg)

        pos_mask = tf.cast(s_y_ture_Lc, tf.bool)
        neg_mask = tf.cast(tf.equal(pos_mask, False), tf.float32)
        neg = neg_mask * s_y_pred_Lc
        vals, _ = tf.nn.top_k(tf.reshape(neg, (1, -1)), k=n_neg)
        threshold = vals[0][-1]

        # threshold = tf.print(threshold,['threshold->',threshold,
        #                                'n_neg>threshold->',tf.reduce_sum(tf.cast(neg>0,tf.int32)),
        #                                's_y_pred_Lc',tf.reduce_sum(tf.cast(s_y_pred_Lc>0.0,tf.int32)),
        #                                'neg->',neg,
        #                                'neg shape->',tf.shape(neg)])

        mask = tf.logical_or(pos_mask, neg > threshold)
        return tf.cast(mask, tf.float32)

    def no_pos():
        mask = tf.zeros_like(s_y_ture_Lc)
        return tf.cast(mask, tf.float32)

    return tf.cond(n_pos > 0, has_pos, no_pos)


def dice_loss(y_true, y_pred, smooth=1.0):
    '''
    相似熵，你可以直接考虑为F值的计算，理解请参考：
    https://zhuanlan.zhihu.com/p/91019893?from_voters_page=true
    Parameters
    ----------
    y_true :
    y_pred :
    smooth :

    Returns
    -------

    '''
    loss = 0.0
    if (BATCH_LOSS):
        intersection = tf.reduce_sum(y_true * y_pred)
        loss = tf.reduce_mean((2.0 * intersection + smooth) / (tf.reduce_sum(y_true) + tf.reduce_sum(y_pred) + smooth))
    else:
        intersection = tf.reduce_sum(y_true * y_pred, axis=(1, 2, 3))
        loss = tf.reduce_mean(
            (2.0 * intersection + smooth) / (tf.reduce_sum(y_true, axis=(1, 2, 3)) + tf.reduce_sum(y_pred, axis=(1, 2, 3)) + smooth))
    return loss


def iou(y_true, y_pred, label: int):
    '''

    Parameters
    ----------
    y_true :
    y_pred :
    label :

    Returns the intersection over union for a given label.
    -------

    '''
    y_true = y_true[:, :, :, -1:]
    y_pred = y_pred[:, :, :, -1:]
    label = tf.cast(label, tf.float32)
    y_true = tf.cast(tf.equal(y_true, label), tf.float32)
    y_pred = y_pred > 0.5
    y_pred = tf.cast(y_pred, tf.float32)
    y_pred = tf.cast(tf.equal(y_pred, label), tf.float32)
    if (METRIC_IOU_BATCH):
        intersecion = tf.reduce_sum(y_true * y_pred)
        union = tf.reduce_sum(y_true) + tf.reduce_sum(y_pred) - intersecion
    else:
        intersecion = tf.reduce_sum(y_true * y_pred, axis=(1, 2, 3))
        union = tf.reduce_sum(y_true, axis=(1, 2, 3)) + tf.reduce_sum(y_pred, axis=(1, 2, 3)) - intersecion

    return tf.reduce_mean((intersecion + 1e-5) / (union + 1e-5))


def build_iou(label: int or Tuple, name: str or Tuple):
    """
    build an intersection over union metric for labels list or label

    Args:
        label:a label list or label int
        name: an optional name for label

    Returns:
        a keras metric to evaluate Iou for the given label

    Note:
        label and name support list inputs for multiple labels
    """

    if isinstance(label, list):
        if (isinstance(name, list)):
            return [build_iou(l, n) for (l, n) in zip(label, name)]
        return [build_iou for i in label]

    def label_iou(y_true, y_pred):
        return iou(y_true, y_pred, label)

    if name is None:
        name = label
    label_iou.__name__ = 'iou_{}'.format(name)
    return label_iou

# @tf.function
def mean_iou(y_true, y_pred, total_iou):
    '''
    compute mean iou
    Parameters
    ----------
    y_true :
    y_pred :

    Returns

    References bug: tf.function-decorated function tried to create variables on non-first call.
    -------

    '''
    num_labels = y_pred.get_shape()[-1]
    for label in range(num_labels):
        total_iou = total_iou + iou(y_true, y_pred, label)
    num_labels = tf.cast(num_labels, dtype=tf.float32)
    return total_iou / num_labels, total_iou